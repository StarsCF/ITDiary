[TOC]
### App 启动时都干了些什么事儿？
- 冷启动是指， App 点击启动前，它的进程不在系统里，需要系统新创建一个进程分配给它启动的情况。这是一次完整的启动过程。
- 热启动是指 ，App 在冷启动后用户将 App 退后台，在 App 的进程还在系统里的情况下，用户重新启动进入 App 的过程，这个过程做的事情非常少。

#### 冷启动

一般而言，App 的启动时间，指的是从用户点击 App 开始，到用户看到第一个界面之间的时间。总结来说，App 的启动主要包括三个阶段：

1. main() 函数执行前；

   - 加载可执行文件（App 的.o 文件的集合）；
   - 载动态链接库，进行 rebase 指针调整和 bind 符号绑定；
   - Objc 运行时的初始处理，包括 Objc 相关类的注册、category 注册、selector 唯一性检查等；
   - 初始化，包括了执行 +load() 方法、attribute((constructor)) 修饰的函数的调用、创建 C++ 静态全局变量;

   针对的启动速度优化，此阶段可以做如下事情，包括：

   - 减少动态库加载。每个库本身都有依赖关系，苹果公司建议使用更少的动态库，并且建议在使用动态库的数量较多时，尽量将多个动态库进行合并。数量上，苹果公司建议最多使用 6 个非系统动态库；
   - 减少加载启动后不会去使用的类或者方法；
   - +load() 方法里的内容可以放到首屏渲染完成后再执行，或使用 +initialize() 方法替换掉；
   - 控制 C++ 全局变量的数量；

2. main() 函数执行后；

   main() 函数执行后的阶段，指的是从 main() 函数执行开始，到 appDelegate 的 didFinishLaunchingWithOptions 方法里首屏渲染相关方法执行完成。

   - 首屏初始化所需配置文件的读写操作；
   - 首屏列表大数据的读取；
   - 首屏渲染的大量计算等。

   此阶段，针对启动速度优化，可以从**功能上梳理出哪些是首屏渲染必要的初始化功能，哪些是 App 启动必要的初始化功能，而哪些是只需要在对应功能开始使用时才需要初始化的**。梳理完之后，将这些初始化功能分别放到合适的阶段进行。

3. 首屏渲染完成后;

   首屏渲染后的这个阶段，主要完成的是，非首屏其他业务服务模块的初始化、监听的注册、配置文件的读取等。从函数上来看，这个阶段指的就是截止到 didFinishLaunchingWithOptions 方法作用域内执行首屏渲染之后的所有方法执行完成。简单说的话，这个阶段就是从渲染完成时开始，到 didFinishLaunchingWithOptions 方法作用域结束时结束。
   
### App 启动速度的监控

   目前来看，对 App 启动速度的监控，主要有两种手段。

1. **定时抓取主线程上的方法调用堆栈，计算一段时间里各个方法的耗时**。

   Xcode 工具套件里自带的 Time Profiler ，采用的就是这种方式。

   这个定时间隔如果小于所有方法执行的时间（比如 0.002 秒），那么基本就能监控到所有方法。但这样做的话，整体的耗时时间就不够准确。一般将这个定时间隔设置为 0.01 秒。这样设置，对整体耗时的影响小，不过很多方法耗时就不精确了。但因为整体耗时的数据更加重要些，单个方法耗时精度不高也是可以接受的，所以这个设置也是没问题的。

   

2. **对 objc_msgSend 方法进行 hook 来掌握所有方法的执行耗时。**

   hook 方法的意思是，在原方法开始执行时换成执行其他你指定的方法，或者在原有方法执行前后执行你指定的方法，来达到掌握和改变指定方法的目的。

   hook objc_msgSend 这种方式的优点是非常精确，而缺点是只能针对 Objective-C 的方法。当然，对于 c 方法和 block 也不是没有办法，你可以使用 libffi 的 ffi_call 来达成 hook，但缺点就是编写维护相关工具门槛高。


   >参考文章链接：
   >
   >1、[02 | App 启动速度怎么做优化与监控？](https://time.geekbang.org/column/article/85331)

